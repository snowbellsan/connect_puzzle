<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ãƒã‚¯ãƒˆãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ </title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        
        /* 1. HTMLã¨BODYã«é«˜ã•ã‚’è¨­å®šã—ã¦ã€ãƒ¢ãƒã‚¤ãƒ«ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«å¯¾å¿œ */
        html, body {
            height: 100%; /* å…¨ç”»é¢é«˜ã•ã‚’ç¢ºä¿ */
            margin: 0;
            padding: 0;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
            touch-action: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* ä¸Šéƒ¨ã«å¯„ã›ã¤ã¤ã€ä¸­å¤®ã«é…ç½® */
            padding-top: 20px; /* ä¸Šéƒ¨ã«å°‘ã—ãƒãƒ¼ã‚¸ãƒ³ */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            color: #ffffff;
            font-family: 'Fredoka One', Arial, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .particle {
            position: fixed;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: none;
            animation: float 3s infinite;
            z-index: 1;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        h1 {
            font-size: 3em;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                         0 0 40px rgba(255, 100, 255, 0.6),
                         0 5px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            animation: title-pulse 2s ease-in-out infinite;
            letter-spacing: 3px;
            z-index: 10;
            position: relative;
        }

        @keyframes title-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #game-container {
            /* 2. æœ€å¤§é«˜ã•ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®95%ã«åˆ¶é™ */
            display: flex;
            flex-direction: column; 
            align-items: center;
            max-height: 95vh; 
            
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 10px;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.2),
                        0 0 100px rgba(138, 43, 226, 0.4),
                        inset 0 0 50px rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 10;
            width: 95%; 
            max-width: 500px;
        }
        
        .main-game-area {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
            /* ãƒœãƒ¼ãƒ‰ã¨æƒ…å ±ãƒ‘ãƒãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã§æœ€å¤§ã®é«˜ã•ã‚’å ã‚ã‚‹ */
            flex-grow: 1; 
            min-height: 0; /* flexã‚¢ã‚¤ãƒ†ãƒ ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼é˜²æ­¢ */
        }

        /* PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (768pxä»¥ä¸Š) */
        #game-info {
            /* PCå‘ã‘ï¼šç¸¦é•·ã®ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« */
            width: 140px; 
            height: 500px; /* å›ºå®šé«˜ã•ã‚’ç¶­æŒ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 0;
            font-size: 1em;
            
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .info-panel {
            text-align: center;
            padding: 15px 5px;
            margin: 0 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .info-panel p {
            font-size: 1.2em; /* ãƒ©ãƒ™ãƒ«ã‚’PCç‰ˆã§ã•ã‚‰ã«å¤§ãã */
            opacity: 0.9;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .info-panel span {
            font-size: 2.2em;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);
            display: block;
        }
        
        #combo-panel {
             border: 2px solid #ff44aa;
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 300px;
            height: 500px;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 50, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5),
                        0 0 30px rgba(138, 43, 226, 0.3);
        }
        
        /* ------------------------------------- */
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (767pxä»¥ä¸‹) */
        /* ------------------------------------- */
        @media (max-width: 767px) {
            h1 {
                font-size: 2em; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã•ã‚‰ã«å°ã•ã */
                margin-bottom: 10px;
            }

            #game-container {
                padding: 5px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
                max-width: 98%;
                /* ç”»é¢ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´å¯èƒ½ãªé«˜ã•ã‚’è¨­å®š */
                height: calc(100% - 20px); /* bodyã®paddingã‚’é™¤ã„ãŸæ®‹ã‚Šã®é«˜ã•ã‚’åˆ©ç”¨ */
            }

            .main-game-area {
                flex-direction: column;
                gap: 5px; /* ç¸¦ã®éš™é–“ã‚’æ¸›ã‚‰ã™ */
                max-height: 100%;
            }

            #game-board {
                width: 100%;
                max-width: 95vw; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¹…ã®95%ã‚’ä¸Šé™ã« */
                /* é«˜ã•ã‚’è¦ªã‚³ãƒ³ãƒ†ãƒŠï¼ˆmain-game-areaï¼‰ã®æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã¦æŸ”è»Ÿã«èª¿æ•´ */
                flex-grow: 1; 
                min-height: 300px; /* æœ€å°é«˜ã•ã‚’è¨­å®š */
                
                /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”6:10ã‚’æŸ”è»Ÿã«ä¿ã¤ãŸã‚ã®èª¿æ•´ */
                /* calc(width / 6 * 10) ã®è¨ˆç®—ã¯CSSã§ã¯é›£ã—ã„ã®ã§ã€flex-growã§é«˜ã•ã‚’ç¢ºä¿ */
                /* ãƒœãƒ¼ãƒ‰ã®å¹…ã‚’ç¢ºå®šã•ã›ã€é«˜ã•ã‚’ãã®æ¯”ç‡ã«åˆã‚ã›ã‚‹ */
                width: min(calc(98vh - 120px) * 0.6, 95vw); /* é«˜ã•ã‹ã‚‰æƒ…å ±ãƒ‘ãƒãƒ«ãªã©ã‚’å¼•ã„ãŸå¹…ã®6/10ã€ã¾ãŸã¯95vwã®å°ã•ã„æ–¹ */
                height: min(calc(98vh - 120px), 95vw / 6 * 10);
            }
            
            /* ãƒœãƒ¼ãƒ‰ã‚’ä¸­å¤®æƒãˆã«ã™ã‚‹ãŸã‚ã®å¾®èª¿æ•´ */
            #game-board {
                align-self: center;
                margin-bottom: 5px;
            }

            #game-info {
                /* ã‚¹ãƒãƒ›å‘ã‘ï¼šãƒœãƒ¼ãƒ‰ã®ä¸‹ã«æ¨ªé•·ã®ãƒ‘ãƒãƒ«ã¨ã—ã¦å†å®šç¾© */
                width: 100%;
                max-width: 400px; /* æ¨ªé•·ãƒ‘ãƒãƒ«ã®æœ€å¤§å¹… */
                height: auto;
                flex-direction: row; 
                justify-content: space-between; 
                gap: 5px;
                padding: 5px;
                /* é«˜ã•å›ºå®š */
                min-height: 60px; 
            }

            .info-panel {
                width: 32%; /* å‡ç­‰3åˆ†å‰²ã«è¿‘ããªã‚‹ã‚ˆã†èª¿æ•´ */
                margin: 0;
                padding: 5px 2px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
            }
            
            .info-panel p {
                font-size: 0.8em; /* ãƒ©ãƒ™ãƒ«ã‚’ã•ã‚‰ã«å°ã•ãã—ã¦åã‚ã‚‹ */
                margin-bottom: 2px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚‚æ¸›ã‚‰ã™ */
                line-height: 1.1; /* è¡Œã®é«˜ã•ã‚’è©°ã‚ã‚‹ */
            }

            .info-panel span {
                font-size: 1.5em; /* æ•°å­—ã‚‚å°ã•ãã—ã¦åã‚ã‚‹ */
            }
        }
        /* ä»¥ä¸‹ã€ãƒœãƒ¼ãƒ«ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ãªã— */

        .ball {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            margin: auto;
            position: relative;
            z-index: 10;
            cursor: pointer;
            transition: grid-row-start 0.5s ease-out, transform 0.3s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5),
                        inset 0 2px 5px rgba(255, 255, 255, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.4);
            filter: brightness(1.1);
        }

        .ball::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 20%;
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8), transparent);
            border-radius: 50%;
        }

        .color-1 { 
            background: radial-gradient(circle at 30% 30%, #ff6666, #ff0000, #cc0000);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.6),
                        inset 0 2px 5px rgba(255, 255, 255, 0.3),
                        0 0 20px rgba(255, 0, 0, 0.4);
        }
        
        .color-2 { 
            background: radial-gradient(circle at 30% 30%, #6666ff, #0000ff, #0000cc);
            box-shadow: 0 5px 15px rgba(0, 0, 255, 0.6),
                        inset 0 2px 5px rgba(255, 255, 255, 0.3),
                        0 0 20px rgba(0, 0, 255, 0.4);
        }
        
        .color-3 { 
            background: radial-gradient(circle at 30% 30%, #66ff66, #00ff00, #00cc00);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.6),
                        inset 0 2px 5px rgba(255, 255, 255, 0.3),
                        0 0 20px rgba(0, 255, 0, 0.4);
        }
        
        .color-4 { 
            background: radial-gradient(circle at 30% 30%, #ffff66, #ffff00, #cccc00);
            box-shadow: 0 5px 15px rgba(255, 255, 0, 0.6),
                        inset 0 2px 5px rgba(255, 255, 255, 0.3),
                        0 0 20px rgba(255, 255, 0, 0.4);
        }
        
        .color-5 { 
            background: linear-gradient(45deg, 
                #ff0000 0%, #ff8000 14%, #ffff00 28%, 
                #00ff00 42%, #0000ff 57%, #8a2be2 71%, 
                #ff0000 85%, #ff8000 100%);
            background-size: 200% 200%;
            animation: rainbow-shift 3s linear infinite;
            border: 4px solid #ffffff;
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.8),
                        inset 0 2px 5px rgba(255, 255, 255, 0.5),
                        0 0 30px rgba(138, 43, 226, 0.6);
        }

        @keyframes rainbow-shift {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .ball.highlight {
            box-shadow: 0 0 30px 8px rgba(255, 255, 255, 1),
                        0 0 60px 15px currentColor,
                        0 5px 15px rgba(0, 0, 0, 0.5);
            transform: scale(1.2) rotate(5deg);
            filter: brightness(1.5);
            animation: highlight-pulse 0.3s ease-in-out infinite;
            z-index: 20;
        }

        @keyframes highlight-pulse {
            0%, 100% { transform: scale(1.2) rotate(5deg); }
            50% { transform: scale(1.25) rotate(-5deg); }
        }
        
        .ball.vanishing {
            animation: vanish-explosion 0.6s forwards;
            pointer-events: none;
        }

        @keyframes vanish-explosion {
            0% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.5) rotate(180deg); 
                opacity: 0.8; 
                filter: brightness(2) blur(2px);
                box-shadow: 0 0 50px 20px currentColor;
            }
            100% { 
                transform: scale(0) rotate(360deg); 
                opacity: 0;
                filter: brightness(3) blur(5px);
            }
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        #overlay.active {
            display: flex;
            animation: overlay-appear 0.5s ease-out;
        }

        @keyframes overlay-appear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        #overlay h2 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                         0 5px 10px rgba(0, 0, 0, 0.5);
            animation: title-pulse 2s ease-in-out infinite;
        }

        #overlay p {
            font-size: 2em;
            margin-bottom: 20px;
        }

        #overlay button {
            padding: 15px 40px;
            margin-top: 20px;
            font-size: 1.5em;
            font-family: 'Fredoka One', Arial, sans-serif;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: 3px solid white;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3),
                        0 0 20px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        #overlay button:hover {
            transform: scale(1.1) rotate(-2deg);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4),
                        0 0 40px rgba(255, 255, 255, 0.5);
        }

        #overlay button:active {
            transform: scale(0.95);
        }

        @keyframes combo-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); color: #ff00ff; }
            100% { transform: scale(1); }
        }

        .combo-active {
            animation: combo-pop 0.5s ease-out;
            box-shadow: 0 0 20px 5px #ff00ff;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>ã‚³ãƒã‚¯ãƒˆãƒ‘ã‚ºãƒ«</h1>
        
        <!-- ãƒœãƒ¼ãƒ‰ã¨æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ -->
        <div class="main-game-area">
            <div id="game-board"></div>
            
            <!-- æƒ…å ±ãƒ‘ãƒãƒ« (PCã§ã¯ç¸¦é•·ã€ã‚¹ãƒãƒ›ã§ã¯æ¨ªé•·) -->
            <div id="game-info">
                <!-- æ™‚é–“ -->
                <div class="info-panel" id="time-panel">
                    <p>â° ã®ã“ã‚Šæ™‚é–“</p>
                    <span id="timer">60</span>
                </div>
                
                <!-- ã‚¹ã‚³ã‚¢ -->
                <div class="info-panel" id="score-panel">
                    <p>ğŸ’ ã‚¹ã‚³ã‚¢</p>
                    <span id="score">0</span>
                </div>

                <!-- ã‚³ãƒ³ãƒœ -->
                <div class="info-panel" id="combo-panel">
                    <p>ğŸ”¥ é€£é–</p>
                    <span id="combo">0</span>
                </div>
            </div>
        </div>
        
        <div id="overlay">
            <h2>ğŸ® ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ğŸ®</h2>
            <p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span></p>
            <button onclick="window.location.reload()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ ğŸ¯</button>
        </div>
    </div>

    <!-- BGMã¨åŠ¹æœéŸ³ç”¨ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´  -->
    <!-- ã“ã‚Œã‚‰ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URLãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ -->
    <audio id="bgm" loop src="assets/The_Seasons_Go_Around.mp3"></audio>
    <audio id="tap-sound" src="assets/ãƒ•ã‚¡ãƒ‹ãƒ¼ã‚¸ãƒ£ãƒ³ãƒ—.mp3"></audio>
    <audio id="vanish-sound" src="assets/ãƒ¬ãƒˆãƒ­ã‚¢ã‚¯ã‚·ãƒ§ãƒ³.mp3"></audio>

    <script>
        // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®ç”Ÿæˆ (æ—¢å­˜ã‚³ãƒ¼ãƒ‰)
        for (let i = 0; i < 20; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDelay = Math.random() * 3 + 's';
            p.style.animationDuration = (Math.random() * 2 + 2) + 's';
            document.body.appendChild(p);
        }

        // --- éŸ³å£°é–¢é€£ã®åˆæœŸè¨­å®š ---
        const bgm = document.getElementById('bgm');
        const tapSound = document.getElementById('tap-sound');
        const vanishSound = document.getElementById('vanish-sound');

        // BGMã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®æ“ä½œå¾Œã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        function startBGM() {
            if (bgm.paused) {
                bgm.volume = 0.3; // BGMã®éŸ³é‡ã‚’èª¿æ•´
                bgm.play().catch(e => console.log('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
            }
        }
        
        // ãƒœãƒ¼ãƒ«ã‚¿ãƒƒãƒ—/ã‚¹ãƒ©ã‚¤ãƒ‰æ™‚ã®åŠ¹æœéŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
        function playTapSound() {
            // åŠ¹æœéŸ³ãŒã™ãã«å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«ã€å†ç”Ÿæ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
            tapSound.currentTime = 0;
            tapSound.volume = 0.5;
            tapSound.play().catch(e => console.log('Tap Soundå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
        }

        // ãƒœãƒ¼ãƒ«æ¶ˆå¤±æ™‚ã®åŠ¹æœéŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
        function playVanishSound() {
            // åŠ¹æœéŸ³ãŒã™ãã«å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«ã€å†ç”Ÿæ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
            vanishSound.currentTime = 0;
            vanishSound.volume = 0.7;
            vanishSound.play().catch(e => console.log('Vanish Soundå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’æ¤œå‡ºã—ã¦BGMã‚’é–‹å§‹
        document.addEventListener('mousedown', startBGM, { once: true });
        document.addEventListener('touchstart', startBGM, { once: true });
        // --- éŸ³å£°é–¢é€£ã®åˆæœŸè¨­å®š çµ‚äº† ---

        const COLS = 6, ROWS = 10, COLOR_COUNT = 4, RAINBOW_COLOR_ID = 5, MIN_CONNECT = 4;
        const BOARD = document.getElementById('game-board');
        const SCORE = document.getElementById('score');
        const TIMER = document.getElementById('timer');
        const COMBO = document.getElementById('combo');
        const COMBO_PANEL = document.getElementById('combo-panel'); // æ–°ã—ã„ãƒ‘ãƒãƒ«è¦ç´ ã‚’å–å¾—
        const FINAL = document.getElementById('final-score');

        let grid = [], path = [], dragging = false, score = 0, time = 60, combo = 0, interval, processing = false;

        function init() {
            score = 0; time = 60; combo = 0; processing = false; dragging = false;
            grid = Array(ROWS).fill().map(() => Array(COLS).fill().map(() => Math.floor(Math.random() * COLOR_COUNT) + 1));
            render();
            setup();
            interval = setInterval(() => {
                if (time > 0 && !processing) { time--; update(); }
                else if (time <= 0) { clearInterval(interval); end(); }
            }, 1000);
            update();
        }

        function update() {
            SCORE.textContent = score;
            TIMER.textContent = time;
            COMBO.textContent = combo;
            
            // ã‚³ãƒ³ãƒœãƒ‘ãƒãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã‚’ä¿®æ­£
            if (combo > 0) {
                COMBO_PANEL.classList.add('combo-active');
                // æ—¢ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†åº¦å®Ÿè¡Œ
                void COMBO_PANEL.offsetWidth; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                COMBO_PANEL.classList.add('combo-active');
            } else {
                COMBO_PANEL.classList.remove('combo-active');
            }
        }

        function render() {
            BOARD.querySelectorAll('.ball').forEach(b => b.remove());
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c]) {
                        const b = make(r, c, grid[r][c]);
                        b.style.gridRowStart = r + 1;
                    }
                }
            }
        }

        function make(r, c, col) {
            const b = document.createElement('div');
            b.className = `ball color-${col}`;
            b.dataset.row = r;
            b.dataset.col = c;
            b.dataset.color = col;
            b.style.gridColumnStart = c + 1;
            BOARD.appendChild(b);
            return b;
        }

        function repos() {
            for (let c = 0; c < COLS; c++) {
                const balls = Array.from(BOARD.querySelectorAll(`.ball[data-col="${c}"]`))
                    .sort((a, b) => parseInt(a.dataset.row) - parseInt(b.dataset.row));
                let idx = 0;
                for (let r = 0; r < ROWS; r++) {
                    const col = grid[r][c];
                    if (idx < balls.length) {
                        const b = balls[idx];
                        b.dataset.row = r;
                        b.style.gridRowStart = r + 1;
                        b.className = `ball color-${col}`;
                        b.dataset.color = col;
                        idx++;
                    } else if (col) {
                        const nb = make(r, c, col);
                        nb.style.gridRowStart = r - ROWS;
                        setTimeout(() => nb.style.gridRowStart = r + 1, 50);
                    }
                }
            }
        }

        function end() {
            processing = true;
            FINAL.textContent = score;
            document.getElementById('overlay').classList.add('active');
            bgm.pause(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«BGMã‚’åœæ­¢
        }

        function setup() {
            BOARD.addEventListener('mousedown', start);
            BOARD.addEventListener('touchstart', start, { passive: true });
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stop);
            BOARD.addEventListener('touchmove', move, { passive: false });
            document.addEventListener('touchend', stop);
        }

        function start(e) {
            if (processing || time <= 0) return;
            // BGMãŒã¾ã å§‹ã¾ã£ã¦ã„ãªã‘ã‚Œã°ã€æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒã§é–‹å§‹ï¼ˆäºŒé‡ã®ãƒªã‚¹ãƒŠãƒ¼é˜²æ­¢ã®ãŸã‚ã€startBGMé–¢æ•°ã¯ä¸€åº¦ã—ã‹å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«è¨­å®šæ¸ˆã¿ï¼‰
            startBGM();
            
            const t = e.target.closest('.ball');
            if (!t) return;
            dragging = true;
            path = [];
            combo = 0;
            add(t);
        }

        function move(e) {
            if (!dragging) return;
            if (e.cancelable) e.preventDefault();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            const t = document.elementFromPoint(x, y);
            if (t && t.classList.contains('ball')) add(t);
        }

        function stop() {
            if (!dragging) return;
            dragging = false;
            if (path.length >= MIN_CONNECT) {
                clear();
                processing = true;
                const balls = path.map(p => ({r: p.r, c: p.c, el: p.el}));
                score += path.length * 10;
                update();
                vanish(balls).then(() => chain());
            } else if (path.length === 1 && path[0].col === RAINBOW_COLOR_ID) {
                rainbow(path[0].r, path[0].c);
            } else {
                clear();
            }
            path = [];
        }

        function clear() {
            BOARD.querySelectorAll('.ball').forEach(b => b.classList.remove('highlight'));
        }

        function add(el) {
            const r = parseInt(el.dataset.row);
            const c = parseInt(el.dataset.col);
            const col = parseInt(el.dataset.color);
            const last = path[path.length - 1];
            
            if (!last) {
                path.push({ r, c, col, el });
                el.classList.add('highlight');
                playTapSound(); // ãƒœãƒ¼ãƒ«ã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ãŸã¨ãã«éŸ³ã‚’é³´ã‚‰ã™
                return;
            }

            const idx = path.findIndex(p => p.r === r && p.c === c);
            if (idx !== -1) {
                if (idx === path.length - 2) path.pop().el.classList.remove('highlight');
                return;
            }

            const adj = Math.abs(r - last.r) <= 1 && Math.abs(c - last.c) <= 1;
            if (!adj) return;

            const pc = path[0].col;
            const same = (col === pc) || (col === RAINBOW_COLOR_ID) || (pc === RAINBOW_COLOR_ID);

            if (same) {
                path.push({ r, c, col, el });
                el.classList.add('highlight');
                playTapSound(); // ãƒœãƒ¼ãƒ«ã‚’ãƒ‘ã‚¹ã«è¿½åŠ ã—ãŸã¨ãã«éŸ³ã‚’é³´ã‚‰ã™
            }
        }

        function rainbow(cr, cc) {
            processing = true;
            combo = 0;
            clear();
            const balls = [];
            for (let r = cr - 1; r <= cr + 1; r++) {
                for (let c = cc - 1; c <= cc + 1; c++) {
                    if (r >= 0 && r < ROWS && c >= 0 && c < COLS && grid[r][c]) {
                        const el = document.querySelector(`.ball[data-row="${r}"][data-col="${c}"]`);
                        if (el) {
                            balls.push({r, c, el});
                            score += 20;
                        }
                    }
                }
            }
            update();
            vanish(balls).then(() => chain());
        }

        function vanish(balls) {
            playVanishSound(); // ãƒœãƒ¼ãƒ«ãŒæ¶ˆãˆã‚‹ã¨ãã«éŸ³ã‚’é³´ã‚‰ã™
            return new Promise(res => {
                balls.forEach(p => {
                    p.el.classList.add('vanishing');
                    grid[p.r][p.c] = 0;
                });
                setTimeout(() => {
                    balls.forEach(p => p.el.remove());
                    res();
                }, 600);
            });
        }

        function chain() {
            processing = true;
            loop();
        }

        function loop() {
            gravity();
            fill();
            repos();
            setTimeout(() => {
                const found = findChains();
                if (found.length > 0) {
                    combo++;
                    score += found.length * 50 * combo;
                    update();
                    playVanishSound(); // é€£é–ã§ãƒœãƒ¼ãƒ«ãŒæ¶ˆãˆã‚‹ã¨ãã«ã‚‚éŸ³ã‚’é³´ã‚‰ã™
                    vanish(found).then(() => loop());
                } else {
                    combo = 0;
                    processing = false;
                    update();
                }
            }, 550);
        }

        function gravity() {
            for (let c = 0; c < COLS; c++) {
                let w = ROWS - 1;
                for (let r = ROWS - 1; r >= 0; r--) {
                    if (grid[r][c]) {
                        if (r !== w) {
                            grid[w][c] = grid[r][c];
                            grid[r][c] = 0;
                        }
                        w--;
                    }
                }
            }
        }

        function fill() {
            for (let c = 0; c < COLS; c++) {
                for (let r = 0; r < ROWS; r++) {
                    if (!grid[r][c]) {
                        grid[r][c] = Math.random() < 0.03 ? RAINBOW_COLOR_ID : Math.floor(Math.random() * COLOR_COUNT) + 1;
                    }
                }
            }
        }

        function findChains() {
            const result = [];
            const seen = new Set();
            
            for (let c = 0; c < COLS; c++) {
                for (let r = 0; r <= ROWS - MIN_CONNECT; r++) {
                    const col = grid[r][c];
                    if (!col) continue;
                    let len = 0;
                    for (let i = r; i < ROWS && grid[i][c] === col; i++) len++;
                    if (len >= MIN_CONNECT) {
                        for (let i = 0; i < len; i++) {
                            const k = `${r + i},${c}`;
                            if (!seen.has(k)) {
                                const el = document.querySelector(`.ball[data-row="${r + i}"][data-col="${c}"]`);
                                if (el) result.push({r: r + i, c, el});
                                seen.add(k);
                                grid[r + i][c] = 0;
                            }
                        }
                    }
                }
            }

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c <= COLS - MIN_CONNECT; c++) {
                    const col = grid[r][c];
                    if (!col) continue;
                    let len = 0;
                    for (let i = c; i < COLS && grid[r][i] === col; i++) len++;
                    if (len >= MIN_CONNECT) {
                        for (let i = 0; i < len; i++) {
                            const k = `${r},${c + i}`;
                            if (!seen.has(k)) {
                                const el = document.querySelector(`.ball[data-row="${r}"][data-col="${c + i}"]`);
                                if (el) result.push({r, c: c + i, el});
                                seen.add(k);
                                grid[r][c + i] = 0;
                            }
                        }
                    }
                }
            }

            for (let r = 0; r <= ROWS - MIN_CONNECT; r++) {
                for (let c = 0; c <= COLS - MIN_CONNECT; c++) {
                    const col = grid[r][c];
                    if (!col) continue;
                    let len = 0;
                    for (let i = 0; r + i < ROWS && c + i < COLS && grid[r + i][c + i] === col; i++) len++;
                    if (len >= MIN_CONNECT) {
                        for (let i = 0; i < len; i++) {
                            const k = `${r + i},${c + i}`;
                            if (!seen.has(k)) {
                                const el = document.querySelector(`.ball[data-row="${r + i}"][data-col="${c + i}"]`);
                                if (el) result.push({r: r + i, c: c + i, el});
                                seen.add(k);
                                grid[r + i][c + i] = 0;
                            }
                        }
                    }
                }
            }

            for (let r = 0; r <= ROWS - MIN_CONNECT; r++) {
                for (let c = MIN_CONNECT - 1; c < COLS; c++) {
                    const col = grid[r][c];
                    if (!col) continue;
                    let len = 0;
                    for (let i = 0; r + i < ROWS && c - i >= 0 && grid[r + i][c - i] === col; i++) len++;
                    if (len >= MIN_CONNECT) {
                        for (let i = 0; i < len; i++) {
                            const k = `${r + i},${c - i}`;
                            if (!seen.has(k)) {
                                const el = document.querySelector(`.ball[data-row="${r + i}"][data-col="${c - i}"]`);
                                if (el) result.push({r: r + i, c: c - i, el});
                                seen.add(k);
                                grid[r + i][c - i] = 0;
                            }
                        }
                    }
                }
            }
            
            return result;
        }

        init();
    </script>
</body>

</html>
